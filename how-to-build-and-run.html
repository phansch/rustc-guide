<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>How to build the compiler and run what you built - Guide to Rustc Development</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="A guide to developing rustc ">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <base href="">

        <link rel="stylesheet" href="book.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme -->
        

        

        <!-- Fetch Clipboard.js from CDN but have a local fallback -->
        <script src="https://cdn.jsdelivr.net/clipboard.js/1.6.1/clipboard.min.js"></script>
        <script>
            if (typeof Clipboard == 'undefined') {
                document.write(unescape("%3Cscript src='clipboard.min.js'%3E%3C/script%3E"));
            }
        </script>

        <!-- Fetch JQuery from CDN but have a local fallback -->
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script>
            if (typeof jQuery == 'undefined') {
                document.write(unescape("%3Cscript src='jquery.js'%3E%3C/script%3E"));
            }
        </script>

        <!-- Fetch store.js from local - TODO add CDN when 2.x.x is available on cdnjs -->
        <script src="store.js"></script>

    </head>
    <body class="light">
        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme = store.get('mdbook-theme');
            if (theme === null || theme === undefined) { theme = 'light'; }
            $('body').removeClass().addClass(theme);
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var sidebar = store.get('mdbook-sidebar');
            if (sidebar === "hidden") { $("html").addClass("sidebar-hidden") }
            else if (sidebar === "visible") { $("html").addClass("sidebar-visible") }
        </script>

        <div id="sidebar" class="sidebar">
            <ul class="chapter"><li><a href="./about-this-guide.html"><strong>1.</strong> About this guide</a></li><li><a href="./how-to-build-and-run.html" class="active"><strong>2.</strong> How to build the compiler and run what you built</a></li><li><a href="./running-tests.html"><strong>3.</strong> Using the compiler testing framework</a></li><li><a href="./walkthrough.html"><strong>4.</strong> Walkthrough: a typical contribution</a></li><li><a href="./high-level-overview.html"><strong>5.</strong> High-level overview of the compiler source</a></li><li><a href="./query.html"><strong>6.</strong> Queries: demand-driven compilation</a></li><li><ul class="section"><li><a href="./incremental-compilation.html"><strong>6.1.</strong> Incremental compilation</a></li></ul></li><li><a href="./the-parser.html"><strong>7.</strong> The parser</a></li><li><a href="./macro-expansion.html"><strong>8.</strong> Macro expansion</a></li><li><a href="./name-resolution.html"><strong>9.</strong> Name resolution</a></li><li><a href="./hir.html"><strong>10.</strong> The HIR (High-level IR)</a></li><li><a href="./ty.html"><strong>11.</strong> The <code>ty</code> module: representing types</a></li><li><a href="./type-inference.html"><strong>12.</strong> Type inference</a></li><li><a href="./trait-resolution.html"><strong>13.</strong> Trait resolution</a></li><li><a href="./type-checking.html"><strong>14.</strong> Type checking</a></li><li><a href="./mir.html"><strong>15.</strong> The MIR (Mid-level IR)</a></li><li><ul class="section"><li><a href="./mir-construction.html"><strong>15.1.</strong> MIR construction</a></li><li><a href="./mir-borrowck.html"><strong>15.2.</strong> MIR borrowck</a></li><li><a href="./mir-optimizations.html"><strong>15.3.</strong> MIR optimizations</a></li></ul></li><li><a href="./trans.html"><strong>16.</strong> Generating LLVM IR</a></li><li><a href="./glossary.html"><strong>17.</strong> Glossary</a></li></ul>
        </div>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page" tabindex="-1">
                
                <div id="menu-bar" class="menu-bar">
                    <div class="left-buttons">
                        <i id="sidebar-toggle" class="fa fa-bars" title="Toggle sidebar"></i>
                        <i id="theme-toggle" class="fa fa-paint-brush" title="Change theme"></i>
                    </div>

                    <h1 class="menu-title">Guide to Rustc Development</h1>

                    <div class="right-buttons">
                        <a href="print.html">
                            <i id="print-button" class="fa fa-print" title="Print this book"></i>
                        </a>
                    </div>
                </div>

                <div id="content" class="content">
                    <a class="header" href="./how-to-build-and-run.html#how-to-build-the-compiler-and-run-what-you-built" id="how-to-build-the-compiler-and-run-what-you-built"><h1>How to build the compiler and run what you built</h1></a>
<p>The compiler is built using a tool called <code>x.py</code>. You will need to
have Python installed to run it. But before we get to that, if you're going to
be hacking on rustc, you'll want to tweak the configuration of the compiler. The default
configuration is oriented towards running the compiler as a user, not a developer.</p>
<a class="header" href="./how-to-build-and-run.html#create-a-configtoml" id="create-a-configtoml"><h3>Create a config.toml</h3></a>
<p>To start, copy <a href="https://github.com/rust-lang/rust/blob/master/config.toml.example"><code>config.toml.example</code></a> to <code>config.toml</code>:</p>
<pre><code class="language-bash">&gt; cd $RUST_CHECKOUT
&gt; cp config.toml.example config.toml
</code></pre>
<p>Then you will want to open up the file and change the following
settings (and possibly others, such as <code>llvm.ccache</code>):</p>
<pre><code class="language-toml">[llvm]
# Enables LLVM assertions, which will check that the LLVM bitcode generated
# by the compiler is internally consistent. These are particularly helpful
# if you edit `trans`.
assertions = true

[rust]
# This enables some assertions, but more importantly it enables the `debug!` logging
# macros that are essential for debugging rustc.
debug-assertions = true

# This will make your build more parallel; it costs a bit of runtime
# performance perhaps (less inlining) but it's worth it.
codegen-units = 0

# I always enable full debuginfo, though debuginfo-lines is more important.
debuginfo = true

# Gives you line numbers for backtraces.
debuginfo-lines = true

# Using the system allocator (instead of jemalloc) means that tools
# like valgrind and memcache work better.
use-jemalloc = false
</code></pre>
<a class="header" href="./how-to-build-and-run.html#running-xpy-and-building-a-stage1-compiler" id="running-xpy-and-building-a-stage1-compiler"><h3>Running x.py and building a stage1 compiler</h3></a>
<p>One thing to keep in mind is that <code>rustc</code> is a <em>bootstrapping</em> compiler. That
is, since <code>rustc</code> is written in Rust, we need to use an older version of the
compiler to compile the newer version. In particular, the newer version of the
compiler, <code>libstd</code>, and other tooling may use some unstable features
internally. The result is the compiling <code>rustc</code> is done in stages.</p>
<ul>
<li><strong>Stage 0:</strong> the stage0 compiler is the current <em>beta</em> compiler; we
download this binary from the internet.</li>
<li><strong>Stage 1:</strong> the code in your clone is then compiled with the stage
0 compiler to produce the stage 1 compiler.</li>
<li><strong>Stage 2:</strong> the code in your clone is then compiled with the stage
1 compiler <em>again</em> to produce the stage 2 compiler (i.e. it builds
itself).</li>
</ul>
<p>For hacking, often building the stage 1 compiler is enough, but for
final testing and release, the stage 2 compiler is used.</p>
<p>Once you've created a config.toml, you are now ready to run
<code>x.py</code>. There are a lot of options here, but let's start with what is
probably the best &quot;go to&quot; command for building a local rust:</p>
<pre><code>./x.py build -i --stage 1 src/libstd
</code></pre>
<p>What this command will do is the following:</p>
<ul>
<li>Using the beta compiler (also called stage 0), it will build the
standard library and rustc from the <code>src</code> directory. The resulting
compiler is called the &quot;stage 1&quot; compiler.
<ul>
<li>During this build, the <code>-i</code> (or <code>--incremental</code>) switch enables incremental
compilation, so that if you later rebuild after editing things in
<code>src</code>, you can save a bit of time.</li>
</ul>
</li>
<li>Using this stage 1 compiler, it will build the standard library.
(this is what the <code>src/libstd</code>) means.</li>
</ul>
<p>This is just a subset of the full rustc build. The <strong>full</strong> rustc build (what you
get if you just say <code>./x.py build</code>) has quite a few more steps:</p>
<ul>
<li>Build stage1 rustc with stage0 compiler</li>
<li>Build libstd with stage1 compiler (up to here is the same)</li>
<li>Build rustc from <code>src</code> again, this time with the stage1 compiler (this part is new)
<ul>
<li>The resulting compiler here is called the &quot;stage2&quot; compiler</li>
</ul>
</li>
<li>Build libstd with stage2 compiler</li>
<li>Build librustdoc and a bunch of other things</li>
</ul>
<a class="header" href="./how-to-build-and-run.html#creating-a-rustup-toolchain" id="creating-a-rustup-toolchain"><h3>Creating a rustup toolchain</h3></a>
<p>Once you have successfully built rustc, you will have created a bunch
of files in your <code>build</code> directory. In order to actually run the
resulting rustc, we recommend creating rustup toolchains. The first
one will run the stage1 compiler (which we built above). The second
will execute the stage2 compiler (which we did not build, but which
you will likely need to build at some point; for example, if you want
to run the entire test suite).</p>
<pre><code>&gt; rustup toolchain link stage1 build/&lt;host-triple&gt;/stage1
&gt; rustup toolchain link stage2 build/&lt;host-triple&gt;/stage2
</code></pre>
<p>Now you can run the rustc you built with. If you run with <code>-vV</code>, you
should see a version number ending in <code>-dev</code>, indicating a build from
your local environment:</p>
<pre><code>&gt; rustc +stage1 -vV
rustc 1.25.0-dev
binary: rustc
commit-hash: unknown
commit-date: unknown
host: x86_64-unknown-linux-gnu
release: 1.25.0-dev
LLVM version: 4.0
</code></pre>
<a class="header" href="./how-to-build-and-run.html#other-xpy-commands" id="other-xpy-commands"><h3>Other x.py commands</h3></a>
<p>Here are a few other useful x.py commands. We'll cover some of them in detail in other sections:</p>
<ul>
<li>Building things:
<ul>
<li><code>./x.py clean</code> – clean up the build directory (<code>rm -rf build</code> works too, but then you have to rebuild LLVM)</li>
<li><code>./x.py build --stage 1</code> – builds everything using the stage 1 compiler, not just up to libstd</li>
<li><code>./x.py build</code> – builds the stage2 compiler</li>
</ul>
</li>
<li>Running tests (see the section <a href="./running-tests.html">running tests</a> for more details):
<ul>
<li><code>./x.py test --stage 1 src/libstd</code> – runs the <code>#[test]</code> tests from libstd</li>
<li><code>./x.py test --stage 1 src/test/run-pass</code> – runs the <code>run-pass</code> test suite</li>
</ul>
</li>
</ul>

                </div>

                <!-- Mobile navigation buttons -->
                
                    <a rel="prev" href="./about-this-guide.html" class="mobile-nav-chapters previous" title="Previous chapter">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="./running-tests.html" class="mobile-nav-chapters next" title="Next chapter">
                        <i class="fa fa-angle-right"></i>
                    </a>
                

            </div>

            
                <a href="./about-this-guide.html" class="nav-chapters previous" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-left"></i>
                </a>
            

            
                <a href="./running-tests.html" class="nav-chapters next" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-right"></i>
                </a>
            

        </div>


        <!-- Local fallback for Font Awesome -->
        <script>
            if ($(".fa").css("font-family") !== "FontAwesome") {
                $('<link rel="stylesheet" type="text/css" href="_FontAwesome/css/font-awesome.css">').prependTo('head');
            }
        </script>

        <!-- Livereload script (if served using the cli tool) -->
        

        

        

        

        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS script -->
        

    </body>
</html>
